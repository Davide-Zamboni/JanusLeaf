### JanusLeaf Auth API - IntelliJ HTTP Client
### Use these requests to test the API directly from IntelliJ

# Variables (can be overridden in http-client.env.json)
@baseUrl = http://localhost:8080/api
@contentType = application/json

### ============================================
### Health Check
### ============================================

### Health Check - No auth required
GET {{baseUrl}}/health
Accept: {{contentType}}

> {%
    client.test("Health check returns UP", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "UP", "Status is not UP");
    });
%}

### ============================================
### Authentication Endpoints
### ============================================

### Register New User
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "test@example.com",
  "username": "TestUser",
  "password": "SecurePass123!"
}

> {%
    client.test("Registration successful", function() {
        client.assert(response.status === 201, "Response status is not 201");
        client.assert(response.body.accessToken !== null, "No access token");
    });
    // Save tokens for subsequent requests
    client.global.set("accessToken", response.body.accessToken);
    client.global.set("refreshToken", response.body.refreshToken);
%}

### Login
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "test@example.com",
  "password": "SecurePass123!"
}

> {%
    client.test("Login successful", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.accessToken !== null, "No access token");
    });
    // Save tokens for subsequent requests
    client.global.set("accessToken", response.body.accessToken);
    client.global.set("refreshToken", response.body.refreshToken);
%}

### Refresh Token
POST {{baseUrl}}/auth/refresh
Content-Type: {{contentType}}

{
  "refreshToken": "{{refreshToken}}"
}

> {%
    client.test("Token refresh successful", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.accessToken !== null, "No access token");
    });
    client.global.set("accessToken", response.body.accessToken);
%}

### ============================================
### Authenticated Endpoints
### ============================================

### Get Current User
GET {{baseUrl}}/auth/me
Authorization: Bearer {{accessToken}}
Accept: {{contentType}}

> {%
    client.test("Get current user successful", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.email !== null, "No email in response");
    });
%}

### Update Profile
PUT {{baseUrl}}/auth/me
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "username": "UpdatedUsername"
}

> {%
    client.test("Profile update successful", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.username === "UpdatedUsername", "Username not updated");
    });
%}

### Change Password
POST {{baseUrl}}/auth/change-password
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "currentPassword": "SecurePass123!",
  "newPassword": "NewSecurePass456!"
}

> {%
    client.test("Password change successful", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });
%}

### Logout
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{accessToken}}

> {%
    client.test("Logout successful", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });
%}

### ============================================
### Error Cases (for testing error handling)
### ============================================

### Login with wrong password (should return 401)
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "test@example.com",
  "password": "WrongPassword123!"
}

> {%
    client.test("Invalid credentials returns 401", function() {
        client.assert(response.status === 401, "Response status is not 401");
        client.assert(response.body.error === "INVALID_CREDENTIALS", "Wrong error code");
    });
%}

### Register with invalid email (should return 400)
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "email": "invalid-email",
  "username": "User",
  "password": "SecurePass123!"
}

> {%
    client.test("Invalid email returns 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
        client.assert(response.body.error === "VALIDATION_ERROR", "Wrong error code");
    });
%}

### Access protected endpoint without token (should return 403)
GET {{baseUrl}}/auth/me
Accept: {{contentType}}

> {%
    client.test("Unauthorized access returns 403", function() {
        client.assert(response.status === 403, "Response status is not 403");
    });
%}
